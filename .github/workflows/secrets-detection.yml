name: Reusable Secrets Detection

on:
  workflow_call:
    secrets:
      GITLEAKS_LICENSE:
        required: true
        description: "Gitleaks license key for authentication"
      SLACK_TECH_WEBHOOK:
        required: false
        description: "Slack webhook URL for security notifications"
    inputs:
      slack_channel:
        description: "Slack channel to send notifications to"
        required: false
        type: string
        default: "buzz-security"

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  gitleaks:
    name: Detect Secrets with Gitleaks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for comprehensive scanning across entire repository
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
          GITLEAKS_ENABLE_COMMENTS: true
          GITLEAKS_NOTIFY_USER_LIST: "@${{ github.event.pull_request.user.login }}"

      - name: Comment on PR if secrets found
        if: failure() && steps.gitleaks.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `## :warning: Secrets Detection Alert

            **Potential secrets or sensitive data have been detected in this pull request.**

            ### Action Required
            - Review the Gitleaks scan results in the workflow logs
            - Remove any hardcoded secrets, API keys, tokens, or sensitive data
            - Use environment variables or GitHub Secrets for sensitive values
            - Consider using Doppler for secret management (as per project standards)

            ### Common Issues
            - API keys and tokens
            - Database credentials
            - Slack webhook URLs
            - Private keys
            - OAuth tokens

            ### Resources
            - [Composio Secret Management Guide](https://github.com/${{ github.repository }}/blob/master/CLAUDE.md#secrets--webhooks)
            - [Gitleaks Documentation](https://github.com/gitleaks/gitleaks)

            **This PR cannot be merged until all secrets are removed.**

            cc: @${{ github.event.pull_request.user.login }}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Slack Notification on Secrets Detection
        if: failure() && steps.gitleaks.outcome == 'failure' && secrets.SLACK_TECH_WEBHOOK != ''
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_TECH_WEBHOOK }}
          SLACK_CHANNEL: ${{ inputs.slack_channel }}
          SLACK_COLOR: danger
          SLACK_TITLE: ":rotating_light: Secrets Detected in PR"
          SLACK_MESSAGE: |
            Potential secrets detected in pull request!
            PR: ${{ github.event.pull_request.title }}
            Author: ${{ github.event.pull_request.user.login }}
            PR Link: ${{ github.event.pull_request.html_url }}

            Please review and remove any hardcoded secrets immediately.
          SLACK_FOOTER: "Security Alert"
          SLACK_USERNAME: "Security Bot"
